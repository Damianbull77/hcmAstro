---
import HabitacionCard from './HabitacionCard.astro';
import type { Habitacion } from '../types/habitacion';

interface Props {
    habitaciones: Habitacion[];
}

const { habitaciones } = Astro.props;
---

<div class="carrusel-container">
    <button class="carrusel-arrow carrusel-arrow-left" aria-label="Anterior">‹</button>
    
    <div class="carrusel-wrapper">
        <div class="carrusel-track" id="carruselTrack">
            {habitaciones.map((hab) => (
                <div class="carrusel-item" data-habitacion-id={hab.id}>
                    <HabitacionCard {...hab} />
                </div>
            ))}
        </div>
    </div>
    
    <button class="carrusel-arrow carrusel-arrow-right" aria-label="Siguiente">›</button>
</div>

<style>
    /* Los mismos estilos que ya tienes */
    .carrusel-container {
        position: relative;
        max-width: 90%;
        margin: 0 auto;
        padding: 40px 0;
    }

    .carrusel-wrapper {
        overflow: hidden;
        width: 100%;
    }

    .carrusel-track {
        display: flex;
        transition: transform 0.5s ease-in-out;
        gap: 20px;
    }

    .carrusel-item {
        flex: 0 0 calc((100% - 40px) / 3);
        min-width: calc((100% - 40px) / 3);
    }

    .carrusel-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: #fff;
        border: 1px solid #ddd;
        font-size: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .carrusel-arrow:hover {
        background: #333;
        color: white;
    }

    .carrusel-arrow-left { left: -25px; }
    .carrusel-arrow-right { right: -25px; }

    @media (max-width: 768px) {
        .carrusel-item {
            flex: 0 0 100%;
            min-width: 100%;
            scroll-snap-align: center;
        }
        .carrusel-arrow { display: none; }
        .carrusel-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }
        .carrusel-wrapper::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }
        .carrusel-track {
            gap: 15px;
            padding: 0 15px;
        }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
        .carrusel-item {
            flex: 0 0 calc((100% - 20px) / 2);
            min-width: calc((100% - 20px) / 2);
        }
    }
</style>

<script>
    // =============================================
    // CARRUSEL INFINITO
    // =============================================
    class CarruselInfinito {
        track!: HTMLElement;
        wrapper!: HTMLElement;
        items!: HTMLElement[];
        currentIndex!: number;
        itemsVisible!: number;
        isTransitioning!: boolean;
        totalOriginal!: number;

        constructor() {
            this.track = document.getElementById('carruselTrack')!;
            if (!this.track) return;
            
            this.wrapper = this.track.parentElement!;
            this.items = Array.from(this.track.querySelectorAll('.carrusel-item')) as HTMLElement[];
            this.totalOriginal = this.items.length;
            this.currentIndex = 0;
            this.itemsVisible = this.getItemsVisible();
            this.isTransitioning = false;

            if (this.items.length > 0) {
                this.init();
            }
        }

        getItemsVisible(): number {
            if (window.innerWidth <= 768) return 1;
            if (window.innerWidth <= 1024) return 2;
            return 3;
        }

        init() {
            this.createClones();
            
            // En mobile usamos scroll nativo, en desktop usamos transform
            if (window.innerWidth <= 768) {
                this.initMobile();
            } else {
                this.initDesktop();
            }

            window.addEventListener('resize', () => {
                const newVisible = this.getItemsVisible();
                const isMobile = window.innerWidth <= 768;
                
                if (newVisible !== this.itemsVisible) {
                    this.itemsVisible = newVisible;
                    
                    // Reinicializar según el nuevo tamaño
                    if (isMobile) {
                        this.initMobile();
                    } else {
                        this.initDesktop();
                    }
                }
            });
        }

        initDesktop() {
            this.updatePosition(false);
            document.querySelector('.carrusel-arrow-left')?.addEventListener('click', () => this.prev());
            document.querySelector('.carrusel-arrow-right')?.addEventListener('click', () => this.next());
            this.track.addEventListener('transitionend', () => this.handleLoop());
        }

        initMobile() {
            // En mobile, posicionar el scroll al inicio de los items reales
            setTimeout(() => {
                const items = this.track.querySelectorAll('.carrusel-item');
                if (items.length > 0) {
                    const itemWidth = (items[0] as HTMLElement).offsetWidth;
                    const gap = 20;
                    const offset = (itemWidth + gap) * this.itemsVisible;
                    this.wrapper.scrollLeft = offset;
                }
            }, 100);

            // Escuchar eventos de scroll para el loop infinito
            let scrollTimeout: NodeJS.Timeout;
            this.wrapper.addEventListener('scroll', () => {
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => this.handleScrollLoop(), 100);
            });
        }

        createClones() {
            for (let i = this.itemsVisible - 1; i >= 0; i--) {
                const clone = this.items[i % this.items.length].cloneNode(true) as HTMLElement;
                clone.classList.add('clone');
                this.track.insertBefore(clone, this.track.firstChild);
            }
            for (let i = 0; i < this.itemsVisible; i++) {
                const clone = this.items[i % this.items.length].cloneNode(true) as HTMLElement;
                clone.classList.add('clone');
                this.track.appendChild(clone);
            }
        }

        updatePosition(animate: boolean) {
            // En mobile no usamos transform, usamos scroll nativo
            if (window.innerWidth <= 768) return;

            const allItems = this.track.querySelectorAll('.carrusel-item');
            if (allItems.length === 0) return;
            const itemWidth = (allItems[0] as HTMLElement).offsetWidth;
            const gap = 20;
            const offset = (itemWidth + gap) * (this.currentIndex + this.itemsVisible);
            this.track.style.transition = animate ? 'transform 0.5s ease-in-out' : 'none';
            this.track.style.transform = `translateX(-${offset}px)`;
            if (!animate) {
                this.track.offsetHeight;
                this.track.style.transition = 'transform 0.5s ease-in-out';
            }
        }

        next() {
            if (this.isTransitioning) return;
            this.isTransitioning = true;
            this.currentIndex++;
            this.updatePosition(true);
        }

        prev() {
            if (this.isTransitioning) return;
            this.isTransitioning = true;
            this.currentIndex--;
            this.updatePosition(true);
        }

        handleLoop() {
            this.isTransitioning = false;
            if (this.currentIndex >= this.totalOriginal) {
                this.currentIndex = 0;
                this.updatePosition(false);
            }
            if (this.currentIndex < 0) {
                this.currentIndex = this.totalOriginal - 1;
                this.updatePosition(false);
            }
        }

        handleScrollLoop() {
            // Solo funciona en mobile
            if (window.innerWidth > 768) return;

            const items = this.track.querySelectorAll('.carrusel-item');
            if (items.length === 0) return;

            const itemWidth = (items[0] as HTMLElement).offsetWidth;
            const gap = 20;
            const singleItemWidth = itemWidth + gap;
            const clonesAtStart = this.itemsVisible;

            const scrollLeft = Math.round(this.wrapper.scrollLeft);
            const firstCloneEnd = singleItemWidth * clonesAtStart;
            const totalElements = this.totalOriginal + (clonesAtStart * 2);
            const lastCloneIndex = totalElements - clonesAtStart;
            const currentVisibleIndex = Math.round(scrollLeft / singleItemWidth);

            // Si llegamos al final (clones), saltar al inicio real
            if (currentVisibleIndex >= lastCloneIndex) {
                this.wrapper.scrollTo({
                    left: firstCloneEnd,
                    behavior: 'auto'
                });
            }
            // Si llegamos al inicio (clones), saltar al final real
            else if (currentVisibleIndex < clonesAtStart) {
                const cloneOffset = clonesAtStart - currentVisibleIndex;
                const targetIndex = this.totalOriginal - cloneOffset;
                const targetScroll = firstCloneEnd + (targetIndex * singleItemWidth);
                this.wrapper.scrollTo({
                    left: targetScroll,
                    behavior: 'auto'
                });
            }
        }
    }

    // =============================================
    // DISPONIBILIDAD (fetch dinámico)
    // =============================================
    async function actualizarDisponibilidad() {
        try {
            const response = await fetch('https://us-central1-hcm2-99b6c.cloudfunctions.net/getDisponibilidad');
            const { disponibilidad } = await response.json();
            
            document.querySelectorAll('[data-habitacion-id]').forEach(item => {
                const id = item.getAttribute('data-habitacion-id');
                if (id && disponibilidad[id] !== undefined) {
                    const badge = item.querySelector('.estado-badge');
                    if (badge) {
                        if (disponibilidad[id]) {
                            badge.textContent = 'DISPONIBLE';
                            badge.className = 'estado-badge disponible';
                        } else {
                            badge.textContent = 'RESERVADA';
                            badge.className = 'estado-badge reservada';
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error actualizando disponibilidad:', error);
        }
    }

    // Inicializar todo cuando el DOM esté listo
    document.addEventListener('DOMContentLoaded', () => {
        new CarruselInfinito();
        actualizarDisponibilidad();
    });
</script>